# =============================================================================
# Mosquitto MQTT Broker Konfiguration
# =============================================================================
# Diese Datei konfiguriert den Eclipse Mosquitto MQTT Broker.
# Mosquitto ist ein leichtgewichtiger MQTT-Broker fuer IoT und Messaging.
#
# Dokumentation: https://mosquitto.org/man/mosquitto-conf-5.html
# =============================================================================

# -----------------------------------------------------------------------------
# Allgemeine Einstellungen
# -----------------------------------------------------------------------------

# Prozess-ID Datei (innerhalb des Containers)
# In Docker-Containern nicht erforderlich - auskommentiert
# pid_file /var/run/mosquitto/mosquitto.pid

# -----------------------------------------------------------------------------
# Netzwerk-Listener
# -----------------------------------------------------------------------------
# Definiert die Ports und Protokolle, auf denen der Broker lauscht.

# MQTT Standard-Protokoll auf Port 1883 (unverschluesselt)
# Verwendet fuer lokale Entwicklung und interne Netzwerke
listener 1883
protocol mqtt

# MQTT mit TLS auf Port 8883 (verschluesselt)
# Verwendet fuer sichere externe Verbindungen
# WICHTIG: Die Zertifikatspfade muessen mit SSL_DOMAIN in ~/.acme.sh/account.conf uebereinstimmen
# Wenn Sie SSL_DOMAIN aendern, aktualisieren Sie diese Pfade entsprechend
listener 8883
protocol mqtt
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/mqtt.unixweb.de.crt
keyfile /mosquitto/certs/mqtt.unixweb.de.key
tls_version tlsv1.2

# WebSocket-Protokoll auf Port 9001 (unverschluesselt)
# Ermoeglicht Browser-basierte MQTT-Clients (z.B. MQTT.js, Paho)
listener 9001
protocol websockets

# WebSocket mit TLS auf Port 8084 (verschluesselt)
# Ermoeglicht sichere Browser-basierte MQTT-Clients
# WICHTIG: Die Zertifikatspfade muessen mit SSL_DOMAIN in ~/.acme.sh/account.conf uebereinstimmen
listener 8084
protocol websockets
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/mqtt.unixweb.de.crt
keyfile /mosquitto/certs/mqtt.unixweb.de.key
tls_version tlsv1.2

# -----------------------------------------------------------------------------
# Persistenz (Datenspeicherung)
# -----------------------------------------------------------------------------
# Speichert Nachrichten und Subscriptions dauerhaft.
# Ermoeglicht Wiederherstellung nach Neustart.

# Persistenz aktivieren
persistence true

# Speicherort fuer persistente Daten
persistence_location /mosquitto/data/

# Persistenz-Datei
persistence_file mosquitto.db

# Autosave-Intervall in Sekunden (0 = nur bei Shutdown)
# Speichert alle 30 Minuten oder bei sauberem Herunterfahren
autosave_interval 1800

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
# Konfiguration der Log-Ausgabe fuer Debugging und Monitoring.

# Log-Datei (innerhalb des Containers)
log_dest file /mosquitto/log/mosquitto.log

# Zusaetzlich auch auf stdout loggen (fuer Docker-Logs)
log_dest stdout

# Log-Level: debug, error, warning, notice, information, subscribe, unsubscribe, all
# Fuer Produktion: error, warning, notice
# Fuer Entwicklung: notice, subscribe, unsubscribe
log_type error
log_type warning
log_type notice
log_type information

# Zeitstempel in Logs aktivieren
log_timestamp true

# Format: ISO 8601 Zeitstempel
log_timestamp_format %Y-%m-%dT%H:%M:%S

# -----------------------------------------------------------------------------
# Authentifizierung und Sicherheit
# -----------------------------------------------------------------------------
# WICHTIG: Diese Einstellungen sind fuer Entwicklungsumgebungen gedacht.
# Fuer Produktion sollte Authentifizierung aktiviert werden!

# Anonyme Verbindungen erlauben
# true  = Keine Authentifizierung erforderlich (Entwicklung)
# false = Authentifizierung erforderlich (Produktion)
allow_anonymous true

# Passwort-Datei fuer Benutzer-Authentifizierung
# Aktivieren Sie diese Zeile und deaktivieren Sie allow_anonymous fuer Produktion:
# password_file /mosquitto/config/passwd

# ACL-Datei fuer Zugriffsrechte (Access Control List)
# Definiert welche Benutzer auf welche Topics zugreifen duerfen:
# acl_file /mosquitto/config/acl

# -----------------------------------------------------------------------------
# Client-Einstellungen
# -----------------------------------------------------------------------------

# Maximale Anzahl gleichzeitiger Verbindungen (-1 = unbegrenzt)
max_connections -1

# Maximale Groesse eines MQTT-Pakets in Bytes (Standard: 10 MB)
# Hinweis: max_packet_size ersetzt das veraltete message_size_limit
max_packet_size 10485760

# Maximale Anzahl von QoS 1 und QoS 2 Nachrichten in der Warteschlange
# pro Client (0 = unbegrenzt, Vorsicht bei Speicherverbrauch)
max_queued_messages 1000

# Maximale Anzahl von QoS 0 Nachrichten in der Warteschlange
max_queued_bytes 0

# Sitzungsablauf fuer persistente Sitzungen
# Format: Zahl + Einheit (s=Sekunden, m=Minuten, h=Stunden, d=Tage)
# Beispiel: 7d = 7 Tage, 24h = 24 Stunden
# Nicht gesetzt = Standard (Sessions laufen nicht ab)
# persistent_client_expiration 7d

# =============================================================================
# Produktion-Hinweise
# =============================================================================
# Fuer produktive Umgebungen sollten folgende Aenderungen vorgenommen werden:
#
# 1. Authentifizierung aktivieren:
#    - allow_anonymous false
#    - password_file /mosquitto/config/passwd
#    - Passwort-Datei erstellen: mosquitto_passwd -c /mosquitto/config/passwd username
#
# 2. TLS/SSL ist bereits aktiviert (siehe Listener-Konfiguration oben):
#    - Port 8883: MQTT mit TLS
#    - Port 8084: WebSocket mit TLS
#    - Zertifikate werden automatisch von acme.sh verwaltet
#
# 3. ACL konfigurieren fuer Topic-basierte Zugriffsrechte
#
# 4. Log-Level reduzieren auf error und warning
# =============================================================================
